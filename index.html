<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flashcards</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .preserve-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [cards, setCards] = useState([]);
      const [idx, setIdx] = useState(0);
      const [flipped, setFlipped] = useState(false);
      const [loading, setLoading] = useState(false);
      const [err, setErr] = useState('');
      const [token, setToken] = useState('');
      const [dbId, setDbId] = useState('');
      const [ready, setReady] = useState(false);

      useEffect(() => {
        const url = new URLSearchParams(location.search);
        const t = url.get('token');
        const d = url.get('database');
        if (t && d) {
          setToken(t);
          setDbId(d);
          load(t, d);
        } else {
          setReady(true);
        }
      }, []);

      const load = async (tk, db) => {
        setLoading(true);
        setErr('');
        try {
          const r = await fetch('/api/notion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: tk, databaseId: db })
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.error || 'Failed');

          const items = (data.results || [])
            .filter(p => p.properties?.Word?.title?.[0]?.plain_text)
            .map(p => ({
              id: p.id,
              front: p.properties.Word.title[0].plain_text,
              back: p.properties.Translation?.rich_text?.[0]?.plain_text || '',
            }));

          const uniq = items.filter((c, i, a) => a.findIndex(x => x.id === c.id) === i);
          setCards(uniq);
          setReady(true);
          if (!uniq.length) setErr('No cards. Check: "Word" (title), "Translation" (text)');
        } catch (e) {
          setErr(e.message);
        } finally {
          setLoading(false);
        }
      };

      const next = () => { setFlipped(false); setTimeout(() => setIdx((i + 1) % cards.length), 300); };
      const prev = () => { setFlipped(false); setTimeout(() => setIdx((i - 1 + cards.length) % cards.length), 300); };

      if (!ready) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow p-6 w-full max-w-md space-y-4">
              <h1 className="text-2xl font-bold text-center">Flashcards</h1>
              <input type="password" placeholder="Notion Token" value={token} onChange={e => setToken(e.target.value)} className="w-full p-2 border rounded"/>
              <input type="text" placeholder="Database ID" value={dbId} onChange={e => setDbId(e.target.value)} className="w-full p-2 border rounded"/>
              <button onClick={() => load(token, dbId)} disabled={loading || !token || !dbId}
                      className="w-full bg-indigo-600 text-white py-2 rounded disabled:opacity-50">
                {loading ? 'Loading...' : 'Load'}
              </button>
              {err && <p className="text-red-600 text-sm">{err}</p>}
            </div>
          </div>
        );
      }

      if (!cards.length) return <div className="min-h-screen flex items-center justify-center"><p>No cards.</p></div>;

      const card = cards[idx];

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4">
          <div className="w-full max-w-lg">
            <div className="flex justify-between mb-4 text-sm">
              <span>{idx + 1}/{cards.length}</span>
              <button onClick={() => { setCards([...cards].sort(() => Math.random() - 0.5)); setIdx(0); }} className="underline">Shuffle</button>
            </div>

            <div className="relative h-80 cursor-pointer" style={{ perspective: '1000px' }} onClick={() => setFlipped(!flipped)}>
              <div className={`absolute inset-0 transition-transform duration-600 preserve-3d ${flipped ? 'rotate-y-180' : ''}`} style={{ transformStyle: 'preserve-3d' }}>
                <div className="absolute inset-0 backface-hidden bg-white rounded-2xl shadow-xl flex items-center justify-center p-8 border-2 border-indigo-200">
                  <div className="text-4xl font-bold text-indigo-700">{card.front}</div>
                </div>
                <div className="absolute inset-0 backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-xl flex items-center justify-center p-6 text-white rotate-y-180">
                  <div className="text-3xl font-bold text-center">{card.back}</div>
                </div>
              </div>
            </div>

            <div className="flex justify-between mt-8">
              <button onClick={prev} className="px-5 py-2 bg-white rounded shadow">Previous</button>
              <button onClick={next} className="px-5 py-2 bg-white rounded shadow">Next</button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
