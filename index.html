<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Language Flashcards - Single/Multi-Source</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .flip-enter { transform: rotateY(0deg); }
    .flip-enter-active { transform: rotateY(180deg); transition: transform 0.6s; }
    .flip-exit { transform: rotateY(180deg); }
    .flip-exit-active { transform: rotateY(0deg); transition: transform 0.6s; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function FlashcardApp() {
      const [cards, setCards] = useState([]);
      const [sourcesCount, setSourcesCount] = useState(0);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [flipped, setFlipped] = useState(false);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [notionToken, setNotionToken] = useState('');
      const [databaseId, setDatabaseId] = useState('');
      const [sourceId, setSourceId] = useState(''); // New: Optional source ID
      const [isConfigured, setIsConfigured] = useState(false);

      // Load from URL params on mount
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const dbId = params.get('database');
        const srcId = params.get('source'); // New: Optional source param
        if (token && dbId) {
          setNotionToken(token);
          setDatabaseId(dbId);
          setSourceId(srcId || ''); // Set if provided
          fetchCards(token, dbId, srcId || null);
        }
      }, []);

      const fetchCards = async (token, dbId, specificSourceId = null) => {
        setLoading(true);
        setError('');
        try {
          const res = await fetch('/api/notion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, databaseId: dbId, sourceId: specificSourceId }) // Pass sourceId to API
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Failed to load flashcards');
          }

          const data = await res.json();
          
          // Handle response (single or multi-source)
          let allResults;
          if (data.data_sources && data.data_sources.length > 0) {
            // Multi-source response
            if (specificSourceId) {
              // Single source requested: Use the first (and only) in response
              allResults = data.data_sources[0]?.results || [];
              setSourcesCount(1);
            } else {
              // All sources
              allResults = data.data_sources.flatMap(source => source.results || []);
              setSourcesCount(data.data_sources.length);
            }
          } else {
            // Legacy single-source
            allResults = data.results || [];
            setSourcesCount(1);
          }

          const formatted = allResults
            .filter(page => 
              page.properties.Word?.title?.[0]?.plain_text &&
              page.properties.Translation?.rich_text?.[0]?.plain_text
            )
            .map(page => ({
              id: page.id,
              front: page.properties.Word.title[0].plain_text,
              back: page.properties.Translation.rich_text[0].plain_text,
              source: page.data_source_id || 'default'
            }));

          // Dedupe by ID
          const uniqueCards = formatted.filter((card, index, self) => 
            index === self.findIndex(c => c.id === card.id)
          );

          setCards(uniqueCards);
          setIsConfigured(true);
          if (uniqueCards.length === 0) setError('No valid flashcards found. Check property names in the source.');
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleConnect = () => {
        if (notionToken && databaseId) fetchCards(notionToken, databaseId, sourceId || null);
      };

      const nextCard = () => {
        setFlipped(false);
        setTimeout(() => {
          setCurrentIndex((prev) => (prev + 1) % cards.length);
        }, 300);
      };

      const prevCard = () => {
        setFlipped(false);
        setTimeout(() => {
          setCurrentIndex((prev) => (prev - 1 + cards.length) % cards.length);
        }, 300);
      };

      if (!isConfigured) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
              <div className="flex items-center gap-3 mb-6">
                <div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center">
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5h18M9 3v2m6-2v2M9 19v2m6-2v2M5 9h14M5 15h14M5 11h14M5 17h14" />
                  </svg>
                </div>
                <h1 className="text-2xl font-bold text-gray-800">Language Flashcards</h1>
              </div>

              <div className="space-y-5">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Notion Token</label>
                  <input
                    type="password"
                    value={notionToken}
                    onChange={(e) => setNotionToken(e.target.value)}
                    placeholder="secret_..."
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                  />
                  <p className="mt-1 text-xs text-gray-500">From notion.so/my-integrations</p>
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Database ID</label>
                  <input
                    type="text"
                    value={databaseId}
                    onChange={(e) => setDatabaseId(e.target.value)}
                    placeholder="2a712bc9f51280ff8d61f0c569a3c0df"
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                  />
                  <p className="mt-1 text-xs text-gray-500">From your Notion DB URL</p>
                </div>

                {/* New: Optional Source ID Input */}
                {databaseId && (
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Data Source ID (Optional)</label>
                    <input
                      type="text"
                      value={sourceId}
                      onChange={(e) => setSourceId(e.target.value)}
                      placeholder="source_xyz789... (leave blank for all sources)"
                      className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                    />
                    <p className="mt-1 text-xs text-gray-500">For multi-source DBs: Use one specific source. Find in DB settings > Data sources.</p>
                  </div>
                )}

                <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                  <h3 className="font-semibold text-indigo-900 mb-2">Required Properties (Per Source):</h3>
                  <ul className="text-sm text-indigo-800 space-y-1">
                    <li>• <strong>Word</strong> → Title type</li>
                    <li>• <strong>Translation</strong> → Rich Text type</li>
                  </ul>
                  <p className="text-xs mt-2">Supports single/multi-source DBs + specific source param!</p>
                </div>

                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-xs">
                  <p><strong>Pro Tip:</strong> Use URL params:</p>
                  <code className="block bg-yellow-100 p-2 rounded mt-1 font-mono text-xs">
                    ?token=xxx&database=yyy [&source=source_zzz]
                  </code>
                </div>

                <button
                  onClick={handleConnect}
                  disabled={!notionToken || !databaseId || loading}
                  className="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold py-3 rounded-lg hover:from-indigo-600 hover:to-purple-600 disabled:opacity-50 transition-all"
                >
                  {loading ? 'Loading...' : 'Load Flashcards'}
                </button>

                {error && (
                  <div className="bg-red-50 text-red-700 p-3 rounded-lg text-sm flex gap-2">
                    <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>{error}</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      if (cards.length === 0) {
        return (
          <div className="min-h-screen flex items-center justify-center p-8">
            <div className="bg-white rounded-2xl shadow-lg p-12 text-center max-w-md">
              <div className="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                <svg className="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2" />
                </svg>
              </div>
              <h3 className="text-xl font-semibold text-gray-700 mb-2">No Flashcards</h3>
              <p className="text-gray-500">Add rows with "Word" and "Translation" in your Notion database source.</p>
            </div>
          </div>
        );
      }

      const card = cards[currentIndex];

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4 md:p-8">
          <div className="w-full max-w-lg">
            {/* Progress */}
            <div className="flex justify-between items-center mb-6 text-sm text-gray-600">
              <span>Card {currentIndex + 1} of {cards.length} <span className="text-indigo-500">(from {sourcesCount} source{sourcesCount > 1 ? 's' : ''})</span></span>
              <button
                onClick={() => { setCards([...cards].sort(() => Math.random() - 0.5)); setCurrentIndex(0); setFlipped(false); }}
                className="flex items-center gap-1 hover:text-indigo-600 transition-colors"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2" />
                </svg>
                Shuffle
              </button>
            </div>

            {/* Flashcard */}
            <div
              className="relative h-80 cursor-pointer preserve-3d"
              style={{ perspective: '1000px' }}
              onClick={() => setFlipped(!flipped)}
            >
              <div
                className={`absolute inset-0 w-full h-full transition-transform duration-600 preserve-3d ${flipped ? 'rotate-y-180' : ''}`}
                style={{ transformStyle: 'preserve-3d' }}
              >
                {/* Front */}
                <div className="absolute inset-0 backface-hidden bg-white rounded-2xl shadow-xl flex flex-col items-center justify-center p-8 border-2 border-indigo-200">
                  <div className="text-4xl font-bold text-indigo-700 mb-4">{card.front}</div>
                  <p className="text-sm text-gray-500">Click to flip</p>
                </div>

                {/* Back */}
                <div className="absolute inset-0 backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-xl flex flex-col items-center justify-center p-8 text-white rotate-y-180">
                  <div className="text-3xl font-bold mb-2">{card.back}</div>
                  <p className="text-sm opacity-90">Click to flip</p>
                </div>
              </div>
            </div>

            {/* Navigation */}
            <div className="flex justify-between mt-8">
              <button
                onClick={prevCard}
                className="flex items-center gap-2 px-5 py-3 bg-white text-gray-700 rounded-lg shadow hover:shadow-md transition-all"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
                Previous
              </button>

              <button
                onClick={nextCard}
                className="flex items-center gap-2 px-5 py-3 bg-white text-gray-700 rounded-lg shadow hover:shadow-md transition-all"
              >
                Next
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>

            <p className="text-center mt-6 text-sm text-gray-500">
              Tip: Click the card to reveal the answer
            </p>
          </div>
        </div>
      );
    }

    // CSS for 3D flip
    const style = document.createElement('style');
    style.innerHTML = `
      .preserve-3d { transform-style: preserve-3d; }
      .backface-hidden { backface-visibility: hidden; }
      .rotate-y-180 { transform: rotateY(180deg); }
    `;
    document.head.appendChild(style);

    ReactDOM.render(<FlashcardApp />, document.getElementById('root'));
  </script>
</body>
</html>
